# measuretoas

This page documents the **`measuretoas`** command-line tool (CLT) in **CRIMP**.
This tool is used to derive pulse **Times of Arrival (ToAs)** by matching observed pulse profiles to a previously generated **template pulse profile**.

`measuretoas` is the main step in the CRIMP timing workflow and produces science-ready ToAs suitable for use with 
Tempo2, PINT, CRIMP’s own fitting utilities, or any other custom-built tool.

---

## Purpose

`measuretoas` measures the phase shift between an observed pulse profile and a reference template over user-defined time intervals.
These phase shifts are converted into pulse Times of Arrival (ToAs), with associated uncertainties.

The tool is designed to handle:
- irregular data sampling
- complex or multi-peaked pulse profiles
- Variable pulse shapes
- optional global (brute-force) minimization to avoid local minima

---

## When should I use this tool?

You should run `measuretoas` when:

- A reliable pulse profile template has already been generated
- Time intervals defining individual ToAs have been created
- You are ready to produce ToAs for timing analysis
- You want ToAs compatible with standard pulsar timing software

This tool is typically run **after**:
- `templatepulseprofile`
- `timeintervalsfortoas`

---

## Required inputs

The command requires the following positional arguments, in this order:

1. **`evtFile`**  
   Name of a **barycentered** FITS event file spanning the desired timing baseline.

2. **`timMod`**  
   Timing model file. Tempo2-style `.par` files are supported.

3. **`tempModPP`**  
   Template pulse profile parameters (e.g., generated by `templatepulseprofile`).

4. **`toagtifile`**  
   User-supplied `.txt` file defining the time intervals for each ToA (generated by `timeintervalsfortoas`).

---

## Quick example

A minimal example looks like:

```bash
measuretoas events_merged.fits model.par template.txt toas_gti.txt
```

A more typical invocation might include energy cuts and output file names:

```bash
measuretoas events_merged.fits model.par template.txt toas_gti.txt \
    -el 1 -eh 5 \
    -tf ToAs_2259 \
    -mf ToAs_2259
```

---

## Core options (most users)

These options are commonly used in practice.

### `-el`, `--enelow`

Low energy filter applied to the event file (in keV).

- Default is 0.5 keV.
- Should generally match the energy range used to build the template.

### `-eh`, `--enehigh`

High energy filter applied to the event file (in keV).

- Default is 10 keV.
- Should generally match the energy range used to build the template.

Using inconsistent energy cuts relative to the template may bias ToAs.

### `-tf`, `--toaFile`

Base name of the output ToA text file.

- Produces `<toaFile>.txt`, containing phase residuals and metadata.
- Also produces a corresponding `.log` file.

### `-mf`, `--timFile`

Name of the output `.tim` file compatible with Tempo2 and PINT.

- If not provided, no `.tim` file is created.
- Recommended when exporting ToAs to external timing packages.

A .tim file can also be generated from `<toaFile>.txt` with the CLT `phshifttotimfile`. Check out
[here](phshifttotimfile.md) for more details.

---

## ToA selection options

These options allow restricting the subset of ToAs that are measured.

### `-ts`, `--toaStart`

Index of the first ToA to measure.

- Default is the first ToA in the interval list.
- Useful for testing or reprocessing subsets of data.

### `-te`, `--toaEnd`

Index of the last ToA to measure.

- Default is the full length of the ToA interval list.
- Can be combined with `-ts` to process a specific range.

---

## Phase-shift and resolution options

### `-pr`, `--phShiftRes`

Phase-shift resolution used during likelihood evaluation.

- Phase step size is `2π / phShiftRes`.
- Default value is 1000.
- Higher values provide finer resolution at increased computational cost.

### `-nb`, `--nbrBins`

Number of bins used to visualize pulse profiles.

- Used **for visualization only**.
- Does not affect the ToA measurement itself.
- Default is 15 bins.

---

## Amplitude and template-parameter options

### `-va`, `--varyAmps`, `--no-varyAmps`

Allow the **pulsed fraction (normalization)** of the template to vary during ToA fitting.

- The pulse **shape is fixed**; only the amplitude is allowed to vary.
- Useful for sources with variable pulsed fractions, such as magnetars.
- Also useful when the background is not stable which can vary the observed pulsed fraction (e.g., for some NICER data). 
- Default is `False`.

### `-rv`, `--readvaryparam`, `--no-readvaryparam`

Read the `vary` keyword for each parameter directly from the template .txt model file.

- Allows fine-grained control over which template parameters are allowed to vary.
- Used in very special cases only (such when pulse-peak migration is observed).
- Default is `False`.

---

## Minimization options

### `-bm`, `--brutemin`, `--no-brutemin`

Enable **global (brute-force) minimization** using a grid search.

- Strongly recommended for multi-peaked, symmetric pulse profiles.
- Helps avoid convergence to incorrect local minima (e.g., wrong peak).
- Default is `False`.

This option is often essential for magnetars such as 1E 2259+586.

---

## Diagnostic plot options

### `-pp`, `--plotPPs`, `--no-plotPPs`

Create pulse profile plots for each ToA interval.

- Useful for visual inspection and debugging.
- Default is `False`.

### `-ll`, `--plotLLs`, `--no-plotLLs`

Create log-likelihood plots as a function of phase shift.

- Useful for visual inspection and debugging.
- Particularly useful when using brute-force minimization.
- Default is `False`.

---

## Verbosity

### `-v`, `--verbose`

Controls the verbosity level of screen output (minimal at the moment).

- No flag: warnings only
- `-v`: informational messages
- `-vv`: debug-level output

---

## Output files

Depending on the options used, `measuretoas` may produce:

- A **ToA text file** (`.txt`)
- A **Tempo2/PINT-compatible `.tim` file**
- Diagnostic **pulse profile plots**
- Diagnostic **log-likelihood plots**
- A **log file** summarizing inputs, options, and warnings

Existing output files are typically overwritten, except for the .tim file.

---

## Common pitfalls and recommendations

- Ensure the template accurately represents the pulse shape over the entire range.
- Use `--brutemin` for double-peaked and nearly symmetric profiles.
- Keep energy cuts consistent across all CRIMP steps.
- Inspect diagnostic plots when results look suspicious.
- Phase wraps at the boundaries of the data span are normal and should be handled during timing-model fitting.

---

## Full option reference

The complete list of options is available via:

```bash
measuretoas -h
```

This page provides guidance on how and when to use each option.

---

## See also

- [Worked example: 1E 2259+586](example_1e2259_toas.md)
- [`templatepulseprofile`](templatepulseprofile.md)
- [`timeintervalsfortoas`](timeintervalsfortoas.md)
- CRIMP `fittoas` command-line tool

---

This page serves as the authoritative reference for the `measuretoas` command-line tool.
